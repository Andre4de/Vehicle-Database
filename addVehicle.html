<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="utf-8"/>
        <title> Add a Vehicle </title>
        <link rel="stylesheet" href="stylesheet.css">
       
        
    </head>

    <body>
       
          <div id="container">

            <header>

                <h1>Add a Vehicle </h1>

                    <nav>
                        <ul>
                            <li><a href="index.html">People Search</a>        
                            <li><a href="vehicle.html">Vehicle Search</a>   
                            <li><a href=""> Add a Vehicle  </a>
                        </ul>
                    </nav>
             </header>

            <div class="sidebar">
                <h3>Sidebar</h3>
                <aside>
                <img src="addveh.png" alt="image of vehicles" class="img">
                 </aside>

  
            </div>

            <div class='main'>
                <h2>Main</h2>
                <form id="addVehicle">

                    <label for="carid">Vehicle ID:</label>
                    <input type="search" id="rego" name="vehiclenum" placeholder="Search...">
                    
                     <br>

                    <label for="carmake">Vehicle Make:</label>
                    <input type="search" id="make" name="vehiclemake" placeholder="Search...">

                    <br>

                    <label for="carmodel">Vehicle Model:</label>
                    <input type="search" id="model" name="vehiclemodel" placeholder="Search...">

                    <br>

                    <label for="carcolour">Vehicle Colour:</label>
                    <input type="search" id="colour" name="vehiclecolour" placeholder="Search...">

                    <br>

                    <label for="carowner">Owner ID:</label>
                    <input type="search" id="owner" name="vehicleowner" placeholder="Search...">

                    <br>

                    <button type="submit" id="click">Add</button> 

                    <br>

                </form>

                 <form id="addVehicle">

                    <label for="carid">Vehicle ID:</label>
                    <input type="search" id="rego" name="vehiclenum" placeholder="Search...">
                    
                     <br>

                    <label for="carmake">Vehicle Make:</label>
                    <input type="search" id="make" name="vehiclemake" placeholder="Search...">

                    <br>

                    <label for="carmodel">Vehicle Model:</label>
                    <input type="search" id="model" name="vehiclemodel" placeholder="Search...">

                    <br>

                    <label for="carcolour">Vehicle Colour:</label>
                    <input type="search" id="colour" name="vehiclecolour" placeholder="Search...">

                    <br>

                    <label for="carowner">Owner ID:</label>
                    <input type="search" id="owner" name="vehicleowner" placeholder="Search...">

                    <br>

                    <button type="submit" id="click">Add</button> 

                    <br>

                </form>

                <br>
                
                <div id="results"></div>
            </div>

            

            <div class="footer">
                <h4>Footer</h4>
                <div id="message"></div>
            </div>

          </div>
          <script type="module" defer>

            import { createClient } from
               'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
   
            const supabase = createClient('https://ugspricsaeopciltqhlf.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnc3ByaWNzYWVvcGNpbHRxaGxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTIyNTYyMjAsImV4cCI6MjAyNzgzMjIyMH0.tXrrGVvxsy5yKal2ROjrDUNWqHbabRehpfI35-MF1vQ');
                let results = document.getElementById("results");
                const newform = document.createElement("form")
                
                newform.id = 'newForm';

                const prsnid = document.createElement("label")
                prsnid.setAttribute('for', 'personid')
                prsnid.textContent = "personID: ";
                const personID = document.createElement("input")
                personID.type = "search"
                personID.id = "personid"
                personID.name = "Personid"
                personID.placeholder = "add"

               

                

                let subBut = document.createElement("button")
                subBut.type = "submit"
                subBut.id = "subHello"
                subBut.textContent = "Say Hello"

            document.getElementById("addVehicle").addEventListener("submit", async function (event){
                event.preventDefault();

                
                
                
                
                let reg = document.getElementById("rego").value
                let mke = document.getElementById("make").value
                let mdl = document.getElementById("model").value
                let clr = document.getElementById("colour").value
                let ownerid = document.getElementById("owner").value

                if(reg === ''|| mke === '' ||mdl === '' || clr === '' || ownerid === ''){
                message.innerHTML = '';
                message.innerHTML = 'Error';
                return;
            }

                console.log("Html action listener works")
                console.log(ownerid)

                try{

                const query = supabase.from("Vehicles").select("OwnerID").eq("OwnerID", ownerid);

                let { data: checkPpl, error : vehErr } = await query;

                if(vehErr)
                throw vehErr

                if(checkPpl.length === 0){
                console.log("No one there")

 
                results.appendChild(newform)
                newform.appendChild(prsnid)
                newform.appendChild(personID)
                newform.appendChild(subBut)

               


                

                }else{
                  
                    console.log("A person with that id already exists.")

                    const query2 = supabase.from('Vehicles').insert({ VehicleID: reg, Make: mke, Model: mdl, Colour: clr, OwnerID: ownerid})

                    const { error: vehIn} = await query2

                    if(vehIn)
                    throw vehin

                    
                }


            }catch(error){
                console.log(error)
            }  

            document.getElementById("newForm").addEventListener("submit", async function (event){
                    event.preventDefault();
                    
                    ownerid = document.getElementById("personid").value


                    console.log("namein")

                    console.log("Nested hello world!");
                    console.log(ownerid)

                    const query3 = supabase.from('People').insert({ PersonID: ownerid, Name: "Andre", Address: "Coventry", DOB: "July", LicenseNumber: "4567", ExpiryDate: "2003"})
                    const query4 = supabase.from('Vehicles').insert({ VehicleID: "anything", Make: "Toyota", Model: "Yaris", Colour: "Black", OwnerID: ownerid})
                    try{
                            const { error : personErr } = await query3

                            if(personErr)
                            throw personErr

                            const { error : vehin2} = await query4

                            if(vehin2)
                            throw vehin2
                    }
                    catch(error)
                    {
                            console.log(error)
                    }
                });


            });
            
                
                      </script> 
                      
                </body>
            
            </html>
    </body>

</html>